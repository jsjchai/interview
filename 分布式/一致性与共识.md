## 一致性与共识

### 一致性保证
* 最终一致性

### 可线行化（强一致性，原子一致性）
> 基本思想是让一个系统看起来好像只有一个数据副本，且所有的操作都是原子的
#### 线性化依赖的条件
* 加锁与主节点选举
* 约束与唯一性保证
* 跨通道的时间依赖
#### 线性化的代价
* CAP理论
* 可线性化与网络延迟
  * CPU内存非线性化 除非使用内存屏障与fence指令

### 分布式事务与共识
> 共识的目标是让几个节点就某件事达成一致
#### 原子提交与两阶段提交（2PC）
> 一种在多节点之间实现事务原子提交的算法，用来确保所有节点要么全部提交，要么全部中止
* 事务管理器 
  * 通常实现是共享库，运行在请求事务相同进程中，也可以是单独的进程或服务
  * 事务管理器发生故障或者网络故障，只能够等待协调者恢复
* 性能下降的原因
  * 为了防奔溃恢复而做的磁盘I/O（fsync）以及额外的网络往返开销

#### 分布式事务概念
* 数据库内部的分布式事务
  * 某些分布式数据库（例如那些标配支持复制和分区的数据库）支持跨数据库节点的内部事务
* 异构分布式事务
  * 在异构分布式事务中，存在两种或两种以上不同的参与者实现技术。即使是完全不同的系统，跨系统的分布式事务必须确保原子提交

#### XA交易
> 异构环境下实施两阶段提交的一个工业标准。XA并不是一个网络协议，而是一个与事务管理器进行通信的C API。
* JAVA中，XA事务是由Java事务API（Java Transaction API,JTA）来实现，JTA可以支持非常多JDBC驱动和消息队列驱动（通过Java消息服务，JMS）
* 启发式决策
  * 这样参与者节点可以在紧急情况下单方面做出决定，放弃或者继续那些停顿的事务，而不需要等到协调者发出指令  

#### 支持容错共识
##### 共识算法性质
* 协商一致性 所有的节点都接受相同的决议
* 诚实性  所有节点不能反悔，即对一项提议不能有两次决定
* 合法性 如果决定了值v，则v一定是由某个节点所提议的
* 可终止性  节点如果不奔溃则最终一定可以达成协议
##### 共识算法
* VSR
* Paxos
* Raft
* Zab
#### 全序广播算法
> 消息按照相同的顺序发送到所有节点，有且只有一次

