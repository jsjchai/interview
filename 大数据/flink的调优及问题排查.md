## 作业配置优化
* 作业并发大时，在作业的高级配置的资源配置中，增加JobManager的资源，提高CPU和内存的大小
* 作业拓扑较复杂时，在作业的高级配置的资源配置中，增加TaskManager的资源，提高CPU和内存的大小
* 不建议修改taskmanager.numberOfTaskSlots，保持默认值1

## 问题排查
### 反压
>  如果你看到一个 task 发生 反压警告（例如： High），意味着它生产数据的速率比下游 task 消费数据的速率要快。 在工作流中数据记录是从上游向下游流动的（例如：从 Source 到 Sink）。反压沿着相反的方向传播，沿着数据流向上游传播
#### 反压的影响
> 反压并不会直接影响作业的可用性，它表明作业处于亚健康的状态，有潜在的性能瓶颈并可能导致更大的数据处理延迟
#### 排查
![image](https://github.com/jsjchai/interview/assets/13389058/9728f65a-ccd4-4a93-a7f1-37eed7ee2b79)

* 使用火焰图分析
#### 原因
* 该节点的发送速率跟不上它的产生数据速率。这一般会发生在一条输入多条输出的 Operator（比如 flatmap）
* 下游的节点接受速率较慢，通过反压机制限制了该节点的发送速率
#### 处理
* 反压可能时暂时的，可能由于负载高峰，CheckPoint或者作业重启引起的数据积压而导致的反压 - 忽略
* 观察Task Thread
  * 分析GC情况
  * 使用火焰图分析
### 迟到的数据
> Event Time语义下我们使用Watermark来判断数据是否迟到。一个迟到元素是指元素到达窗口算子时，该元素本该被分配到某个窗口，但由于延迟，窗口已经触发计算
#### 处理方式
* 直接将迟到数据丢弃
* 将迟到数据发送到另一个流
* 重新执行一次计算，将迟到数据考虑进来，更新计算结果
### 数据倾斜
> 数据倾斜就是数据的分布严重不均，造成一部分数据很多，一部分数据很少的局面
#### 影响-反压
* 单点问题
   * 数据集中在某些分区上（Subtask），导致数据严重不平衡
* GC 频繁
   * 过多的数据集中在某些 JVM（TaskManager），使得JVM 的内存资源短缺，导致频繁 GC
* 吞吐下降、延迟增大
   * 数据单点和频繁 GC 导致吞吐下降、延迟增大
*  系统崩溃
  *  过长的 GC 导致 TaskManager 失联，系统崩溃
#### 处理
* 数据源 source 消费不均匀
  * 通过调整并发度，解决数据源消费不均匀或者数据源反压的情况
* key 分布不均匀的无统计场景
  * key 分布不均匀的无统计场景，例如上游数据分布不均匀，使用keyBy来打散数据
      * 通过添加随机前缀，打散 key 的分布，使得数据不会集中在几个 Subtask
* key 分布不均匀的统计场景
  *  聚合统计前，先进行预聚合，例如两阶段聚合（加盐局部聚合+去盐全局聚合）
      *  预聚合：加盐局部聚合，在原来的 key 上加随机的前缀或者后缀
      *  聚合：去盐全局聚合，删除预聚合添加的前缀或者后缀，然后进行聚合统计
    



